---
- hosts: default
  become: true
  tasks:
    - name: create /opt/first_apt_cache_update_done
      copy:   dest=/opt/first_apt_cache_update_done content="" force=no
      notify: upgrade packages
      # Upgrade packages on first provisioning, but not later.
      # If you want packages to be upgraded later,
      # delete /opt/first_apt_cache_update_done and re-provision.
    - name: reconfigure locales
      template: src=locale.gen.j2 dest=/etc/locale.gen owner=root group=root
      notify: re-generate locales
      # correct locales are needed for postgres to install properly.

    - meta: flush_handlers
      # To make sure packages are upgraded before we install more stuff

    - name: uninstall exim4
      apt: name=exim4* state=absent
    - name: install php5
      apt: name=php5-cli state=installed
    - name: install php5-pgsql
      apt: name=php5-pgsql state=installed
    - meta: flush_handlers
    - name: install postgres-9.4
      apt: name=postgresql-9.4 state=installed
    - name: install psycopg2
      apt: name=python-psycopg2 state=installed
    - name: create pg superuser for vagrant
      postgresql_user: name=vagrant role_attr_flags=SUPERUSER
      become_user: postgres
    - name: create pg user for tests
      postgresql_user: name=snake_druid_testing role_attr_flags=CREATEDB password=baa
      become_user: postgres

    - name: install composer
      shell: curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
      args:
        creates: /usr/local/bin/composer

  handlers:
    - name: re-generate locales
      command: /usr/sbin/locale-gen
    - name: upgrade packages
      apt: update_cache=yes upgrade=safe
